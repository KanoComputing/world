<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../kano-style/typography.html">
<link rel="import" href="../kano-style/color.html">
<link rel="import" href="../kano-session/kano-session.html">
<link rel="import" href="../kano-carousel/kano-carousel.html">
<link rel="import" href="../kano-step/kano-step.html">
<link rel="import" href="../../js/config.html">
<link rel="import" href="../kano-projects-listing/kano-projects-listing-behavior.html">


<dom-module id="kw-projects-header">
    <template>
        <style>
            .header {
                @apply --layout-vertical;
                @apply --layout-center;
                text-align: center;
                background-color: #263A48;
                color: #fff;
                padding: 30px 0 40px;
            }
            h3 {
                font-size: 38px;
                margin: 40px 20px 0;
                line-height: 35px;
            }
            h4 {
                font-size: 18px;
                margin: 10px 0 40px 0;
                font-weight: normal;
            }
            .toggle-container {
                @apply --layout-vertical;
                opacity: 0;
                transform: translateY(100px);
                transition: 300ms ease-out;
            }
            .projects {
                @apply --layout-horizontal;
                flex: 1;
                justify-content: center;
                padding: 0 36px;
                overflow-y: visible;
            }
            .projects > a {
                position: relative;
                margin: 10px 12px;
                text-decoration: none;
            }
            .project-groups {
                @apply --layout-vertical;
                @apply --layout-start-justified;
                width: 100%;
                max-width: 840px;
            }
            .project-group {
                margin-bottom: 10px;
                position: relative;
            }
            .project-group iron-image {
                width: 150px;
                height: 118px;
            }
            .project-group-header {
                @apply --layout-horizontal;
                @apply --layout-center;
                margin: auto 10px;
            }
            .project-group-info {
                @apply --layout-vertical;
                text-align: left;
                margin: 0 0 10px 25px;
            }
            .project-group-info h4 {
                font-size: 18px;
                margin: 0;
                padding-top: 30px;
                font-weight: normal;
            }
            .project-group-info p {
                font-size: 16px;
                margin: 0;
            }
            .step-display {
                @apply --layout-horizontal;
                height: 120px;
            }
            kano-step {
                min-width: 120px;
                height: 120px;
            }
            .step-icon {
                background-image: url("/assets/projects/simple-progress/lock-circle.svg");
                background-color: #263A48;
                background-size: 64%;
                background-repeat: no-repeat;
                background-position: center;
                flex: 1;
                height: 60px;
                width: 60px;
            }
            .step-icon a {
                /*a to take icon's dimension and disable link by default*/
                display: flex;
                flex: 1;
                height: 100%;
                pointer-events: none;
            }
            kano-step:first-child .step-icon:not(.done) {
                background-image: url("/assets/projects/simple-progress/make-button.svg");
                background-size: 82%;
                width: 110px;
                height: 60px;
            }
            .step-icon.locked {
                background-image: url("/assets/projects/simple-progress/lock-circle.svg");
            }
            .step-icon.current {
                background-image: url("/assets/projects/simple-progress/make-button.svg");
                background-size: 82%;
                width: 110px;
                height: 60px;
            }
            /*TODO refactor*/
            .step-icon.current a,
            .step-icon.done a,
            kano-step:first-child .step-icon:not(.done) a {
                pointer-events: auto;
            }
            .step-icon.done {
                background-image: url("/assets/projects/simple-progress/star.svg");
                height: 60px;
                width: 60px;
            }
            kano-step:last-child .step-icon {
                background-image: url("/assets/projects/simple-progress/lock-circle-large.svg");
                background-size: 70%;
                width: 120px;
                height: 120px;
            }
            kano-step:last-child .step-icon.current {
                background-image: url("/assets/projects/simple-progress/make-button-big.svg");
                background-size: 70%;
                width: 120px;
                height: 84px;
            }
            kano-step:last-child .step-icon.done {
                background-image: url("/assets/projects/simple-progress/complete-row.svg");
                background-size: 70%;
                background-position: bottom;
                width: 120px;
                height: 120px;
                padding-top: 20px;
            }
            .left-button, .right-button {
                font-family: var(--font-body);
                position: absolute;
                top: 0;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.4);
                color: white;
                font-size: 40px;
                font-weight: bold;
                border: 0;
                cursor: pointer;
                padding: 12px;
            }
            .left-button:focus, .right-button:focus {
                outline: none;
            }
            .left-button {
                left: 0;
            }
            .right-button {
                right: 0;
            }
            .new-project-field {
                box-sizing: border-box;
                background-color: #F5F5F5;
                overflow: auto;
            }
            .new-project-field h4 {
                display: flex;
                justify-content: center;
                text-align: center;
                margin: 0;
                padding: 43px 25px 16px;
                font-size: 18px;
                font-weight: 400;
                color: var(--color-grey-darker, #666);
            }
            .new-project-field button {
                display: block;
                margin: 0 auto 45px;
                background-color: #7ac943;
                color: white;
                border: none;
                font-size: 16px;
                padding: 14px 20px;
                cursor: pointer;
            }
            @media screen and (max-width: 980px) {
                .new-project-field button {
                    font-size: 14px;
                }
            }
            @media screen and (max-width: 680px) {
                .new-project-field h4 {
                    padding: 23px 25px 13px;
                }
                .new-project-field button {
                    margin-bottom: 25px;
                }
            }
        </style>
        <kano-session id="session" user="{{user}}" include-profile></kano-session>
        <div class="header">
                <h3>Kano gives you coding powers</h3>
                <h4>The more challenges you do, the more powerful you'll become</h4>
                <div class="project-groups">
                    <div class="project-group">
                        <div class="project-group-header">
                            <iron-image src="/assets/projects/simple-progress/speaker.png" preload fade sizing="contain"></iron-image>
                            <div class="project-group-info">
                                <h4>The power to make your computer speak</h4>
                            </div>
                        </div>
                        <kano-carousel>
                            <button type="button" slot="left-button" class="left-button" carousel-control-left>&lt;</button>
                                <div id="speaker_puzzles" class="step-display" slot="content">
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_hello"></a>
                                                </div>
                                        </div>
                                        <div slot="label">1</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_cannot_think"></a>
                                                </div>
                                        </div>
                                        <div slot="label">2</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_code_me_loop"></a>
                                                </div>
                                        </div>
                                        <div slot="label">3</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_sound"></a>
                                                </div>
                                        </div>
                                        <div slot="label">4</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_sound_loop"></a>
                                                </div>
                                        </div>
                                        <div slot="label">5</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_button_trigger"></a>
                                                </div>
                                        </div>
                                        <div slot="label">6</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/speaker_drum_machine"></a>
                                                </div>
                                        </div>
                                        <!-- passing empty string to avoid UI issues for now -->
                                        <div slot="label"></div>
                                    </kano-step>
                                </div>
                            <button type="button" slot="right-button" class="right-button" carousel-control-right>&gt;</button>
                        </kano-carousel>
                    </div>
                    <div class="project-group">
                        <div class="project-group-header">
                            <iron-image src="/assets/projects/simple-progress/screen.png" class="screen" preload fade sizing="contain"></iron-image>
                            <div class="project-group-info">
                                <h4>The power over your computer's screen</h4>
                            </div>
                        </div>
                        <kano-carousel>
                            <button type="button" slot="left-button" class="left-button" carousel-control-left>&lt;</button>
                                <div id="screen_puzzles" class="step-display" slot="content">
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_draw_pixel"></a>
                                                </div>
                                        </div>
                                        <div slot="label">1</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_pixel_flood"></a>
                                                </div>
                                        </div>
                                        <div slot="label">2</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_subpixels"></a>
                                                </div>
                                        </div>
                                        <div slot="label">3</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_colorful_shapes"></a>
                                                </div>
                                        </div>
                                        <div slot="label">3</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_stars"></a>
                                                </div>
                                        </div>
                                        <div slot="label">3</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_space_sticker"></a>
                                                </div>
                                        </div>
                                        <div slot="label">4</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/screen_space_scene"></a>
                                                </div>
                                        </div>
                                        <div slot="label">5</div>
                                    </kano-step>
                                </div>
                            <button type="button" slot="right-button" class="right-button" carousel-control-right>&gt;</button>
                        </kano-carousel>
                    </div>
                    <div class="project-group">
                        <div class="project-group-header">
                            <iron-image src="/assets/projects/simple-progress/pixel.png" class="pixel" preload fade sizing="contain">
                            </iron-image>
                            <div class="project-group-info">
                                <h4>The power to control light</h4>
                            </div>
                        </div>
                        <kano-carousel>
                            <button type="button" slot="left-button" class="left-button" carousel-control-left>&lt;</button>
                                <div id="pixel_puzzles" class="step-display" slot="content">
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/pixel_lights_on"></a>
                                                </div>
                                        </div>
                                        <div slot="label">1</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/pixel_color_picker"></a>
                                                </div>
                                        </div>
                                        <div slot="label">2</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/pixel_color_random_loop"></a>
                                                </div>
                                        </div>
                                        <div slot="label">3</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/pixel_point"></a>
                                                </div>
                                        </div>
                                        <div slot="label">4</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/pixel_emoji"></a>
                                                </div>
                                        </div>
                                        <div slot="label">5</div>
                                    </kano-step>
                                    <kano-step vertical>
                                        <div slot="icon">
                                                <div class="step-icon">
                                                    <a href$="[[config.KANO_CODE_URL]]/story/pixel_colorful_point_loop"></a>
                                                </div>
                                        </div>
                                        <!-- passing empty string to avoid UI issues for now -->
                                        <div slot="label"></div>
                                    </kano-step>
                                </div>
                            <button type="button" slot="right-button" class="right-button" carousel-control-right>&gt;</button>
                        </kano-carousel>
                    </div>
                </div>
        </div>
        <div class="new-project-field">
            <h4>Start your next project from scratch, <br>or try out the challenges below to earn XP</h4>
            <button type="button" on-click="_openModal">start a new project</button>
        </div>
    </template>
    <script>
        Polymer({
            is: 'kw-projects-header',
            behaviors: [
                Kano.ProjectsListingBehavior
            ],
            observers: [
                '_computeProgress(user)'
            ],
            attached () {
                this.config = Kano.World.config;
            },
            _computeProgress (user) {
                if (user && user.profile && user.profile.stats['make-apps'] && user.profile.stats['make-apps'].progress) {
                    this._updateProgress(user.profile.stats['make-apps'].progress);
                } else {
                    //remove all additional classes if user has logged out
                    Polymer.dom(this.root).querySelectorAll('.step-icon').forEach(el => el.className = 'step-icon');
                    this._computeStoredProgress();
                }
            },
            _computeStoredProgress () {
                let storedProgress = localStorage.getItem('progress');
                if (storedProgress) {
                    storedProgress = JSON.parse(storedProgress);
                    this._updateProgress(storedProgress);
                }
            },
            _openModal () {
                this.fire('show-modal');
            },
            _updateProgress (progress) {
                Polymer.dom(this.root).querySelectorAll('.step-display').forEach((el) => {
                    if (progress[el.id]) {
                        let steps = el.querySelectorAll('.step-icon');
                        for (let i = 0, len = steps.length; i < len; i++) {
                            if (i < progress[el.id].completedStories.length) {
                                steps[i].classList.add("done");
                            } else if (i === progress[el.id].completedStories.length) {
                                steps[i].classList.add("current");
                            }
                        }
                    }
                })
            }
        });
    </script>
</dom-module>
