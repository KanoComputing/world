<link rel="import" href="../../bower_components/web-components/kano-api-client-behavior/kano-api-client-behavior.html">

<script>
    (function (Kano) {

        // @polymerBehavior
        let ShareWrapperBehavior = {
            properties: {
                selectedShare: {
                    type: Object,
                    notify: true,
                    observer: '_selectedShareChanged'
                },
                user: {
                    type: Object,
                    notify: true
                }
            },
            _getMoreComments (id, page) {
                if (!id) {
                    return;
                }
                let path = `${this._getUrl('share-comments', {id})}?feature=true&page=${page}&limit=3`;
                fetch(path)
                    .then(r => r.json())
                    .then(r => {
                        this.set('selectedShare.pageNumber', r.next);
                        if (page === 0 ){
                            this.set('selectedShare.comments', r.entries);
                        } else {
                            r.entries.forEach(item => {
                                this.push('selectedShare.comments', item);
                            });
                        }
                    });
            },
            _getShareComments (id) {
                return this.cacheOrAPI(`${this._getUrl('share-comments', {id})}?feature=true&page=0&limit=3`)
                    .then(r => {
                        this.set('selectedShare.pageNumber', r.next);
                        this.set('selectedShare.comments', r.entries);
                    });
            },
            _loadMoreData (e) {
                let card = e.detail;
                if (!card.id || !card.page) {
                    return;
                }
                this._getMoreComments(card.id, card.page);
            },
            _onFollowAction (e) {
                if (!this.user) {
                    this.fire('login');
                    return;
                }
                let follow = e.detail.action === 'follow',
                    userId = e.detail.id,
                    method = follow ? 'POST' : 'DELETE';
                if (this.user.id !== userId) {
                    if (follow) {
                        this.push('user.profile.following', userId);
                    } else {
                        this._removeFollowee(userId);
                    }
                    let headers = new Headers({
                        'Authorization': this.token,
                        'Content-Type': 'application/json'
                    });
                    fetch(this._getUrl('follow', { userId }), {
                        method,
                        headers
                    })
                    .then((response) => response.json())
                    .catch((err) => {
                        if (follow) {
                            this._removeFollowee(userId);
                        } else {
                            this.push('user.profile.following', userId);
                        }
                    })
                }
            },
            _onLikeAction (e) {
                if (!this.user) {
                    this.fire('login');
                    return;
                }
                let id = e.detail.id,
                    liked = e.detail.liked,
                    userId = e.detail.userId,
                    method = liked ? 'POST' : 'DELETE';
                if (this.user.id !== userId) {
                    let headers = new Headers({
                        'Authorization': this.token,
                        'Content-Type': 'application/json'
                    });
                    fetch(this._getUrl('like-share', { id }), {
                        method,
                        headers
                    })
                    .then((response) => response.json())
                    .then((response) => {
                        if (response.success) {
                            if (response.item) {
                                this.push('selectedShare.likes', response.item);
                            } else {
                                this._removeSelectedLike();
                            }
                        }
                    })
                }
            },
            _onPostComment (e) {
                if (!this.user) {
                    this.fire('login');
                    return;
                }
                let commentBody = e.detail.value,
                retry = e.detail.retry,
                    requestBody = {
                        item_id: this.selectedShare.id,
                        type: 'share',
                        text: commentBody
                    },
                    requestHeaders = new Headers(),
                    postingComment = {
                        author: this.user,
                        text: commentBody,
                        date_created: new Date(),
                        posting: true,
                        error: ''
                    };

                if (!this.selectedShare.comments) {
                    this.set('selectedShare.comments', []);
                }

                if (!retry) {
                    this.unshift('selectedShare.comments', postingComment);
                }

                requestHeaders.append('Content-Type', 'application/json');
                requestHeaders.append('Authorization', this.token);

                fetch(this._getUrl('post-comment'), {
                    method: 'POST',
                    headers: requestHeaders,
                    body: JSON.stringify(requestBody)
                }).then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            this.set('selectedShare.comments.0.posting', false);
                        }
                    }).catch(error => {
                        this.set('selectedShare.comments.0.error', true);
                    });
            },
            _removeFollowee (id) {
                this.user.profile.following.forEach((userId, index) => {
                    if (userId === id) {
                        this.splice('user.profile.following', index, 1);
                    }
                });
            },
            _removeSelectedLike () {
                this.selectedShare.likes.forEach((like, index) => {
                    if (like.user === this.user.id) {
                        this.splice('selectedShare.likes', index, 1);
                    }
                });
            },
            _selectedShareChanged (share) {
                if (share) {
                    this._getShareComments(share.id);
                }
            }
        };

    Kano.ShareWrapperBehavior = [
        window.Kano.APIClient,
        ShareWrapperBehavior
    ];

    })(window.Kano = window.Kano || {});
</script>
