<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../kano-api-client/kano-api-client-behavior.html">
<link rel="import" href="../../bower_components/date-util/date-util.html">
<link rel="import" href="../../bower_components/web-components/kano-style/color.html">
<link rel="import" href="../../bower_components/web-components/kano-style/button.html">
<link rel="import" href="../../bower_components/web-components/kano-style/typography.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../kano-api-client/kano-api-client-behavior.html">
<dom-module id="kw-social-comment">
    <template>
        <style>
             :host {
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-justified;
                background-color: var(--color-grey-lightest);
                width: 100%;
                padding-bottom: 54px;
            }
            :host([tombstone]) * {
                visibility: hidden;
            }
            [hidden] {
                display: none !important;
            }
            .comment-button {
                position: absolute;
                @apply --kano-button;
                background: var(--color-orange);
                right: 5px;
                bottom: 5px;
                padding: 10px;
            }
            .comment-button:focus {
                outline: none;
                background: #ec6400;
            }
            .comment-button img {
                margin-left: 3px;
                margin-top: 2px;
            }
            h3 {
                color: var(--color-grey-dark);
                font-size: 16px;
                line-height: 43px;
                font-family: var(--font-body);
                display: none;
            }
            .input-comment {
                @apply --layout-horizontal;
                @apply --layout-center;
                width: 80%;
                margin: 32px;
            }
            .comment-avatar {
                @apply --layout-flex-1;
                margin-left: 16px;
                margin-right: 16px;
            }
            iron-image {
                height: 35px;
                width: 35px;
                border-radius: 50%;
            }
            .input-comment .comment-box {
                position: relative;
                @apply --layout-horizontal;
                @apply --layout-center;
                border-radius: 3px;
                border: 1px solid var(--color-grey-lighter);
                width: 90%;
                background: white;
            }
            .input-comment .comment-box::after {
                position: absolute;
                left: -8px;
                content: '';
                box-sizing: border-box;
                width: 15px;
                height: 15px;
                border: 1px solid var(--color-grey-lighter);
                border-top: 0px;
                border-right: 0px;
                background: linear-gradient(45deg, white 0%,white 51%,transparent 52%, transparent 100%);
                transform: rotate(45deg);
            }
            .input-comment .comment-box iron-autogrow-textarea {
                font-size: 14px;
                width: 100%;
                border: none;
                padding: 14px 4px;
                --iron-autogrow-textarea: {
                    padding: 14px 7px;
                };
            }
            .comment {
                width: 80%;
                height: 100px;
                @apply --layout-horizontal;
                @apply --layout-center;
            }
            .comment.optimistic {
                opacity: 0.6;
            }
            .content {
                font-size: 16px;
                font-family: var(--font-body);
                color: var(--color-grey-dark);
                width: 100%;
            }
            .content p b {
                margin-right: 6px;
            }
            .content p {
                margin-top: 6px;
                margin-bottom: 6px;
            }
            .content date-util {
                font-size: 14px;
                font-family: var(--font-body);
                color: var(--color-grey-dark);
            }
            p {
                font-family: var(--font-body);
                color: var(--color-grey-dark);
                font-size: 16px;
            }
            span.bold {
                font-weight: bold;
                margin-right: 5px;
            }
            h3[shown] {
                display: block;
            }
            iron-list {
                width: 80%;
                height: 100%
            }
            .loader {
                @apply --kano-button;
                background: var(--color-orange);
                width: 80%;
                padding: 10px;
                text-align: center;
            }
            .loader[hidden] {
                display: block;
            }
            .error {
                @apply --kano-button;
                background: var(--color-red);
                padding: 8px;
                width: 80px;
                text-align: center;
            }
        </style>
        <h3 shown$="[[!comments.length]]">Be the first to comment!</h3>
        <div class="input-comment">
            <div class="comment-avatar">
                <iron-image preload placeholder="https://s3-eu-west-1.amazonaws.com/world.kano.me/users/avatars/563890fec4d6960800c721f7/avatar-circle.png" fade sizing="contain"></iron-image>
            </div>
            <div class="comment-box">
                <iron-autogrow-textarea id="comment"
                                        placeholder="Type your message ..."
                                        max-rows="7"></iron-autogrow-textarea>
                <button class="orange-button comment-button" on-tap="_commentButtonTapped">
                    <span>comment</span>
                    <img src="/assets/icons/shares/comment.svg" />
                </button>
            </div>
        </div>
        <p>Remember to be nice</p>
        <iron-list items="[[comments]]" as="comment" hidden$="[[comment]]">
                <template>
                    <div class$="comment [[_computeOptimisticClass(comment.optimistic)]]">
                        <div class="comment-avatar">
                            <iron-image preload placeholder="/assets/icons/shares/commentAvatar.svg" fade sizing="contain" src="{{comment.author.avatar.urls.circle}}"></iron-image>
                        </div>
                        <div class="content">
                            <p><span class="bold">{{comment.author.username}}</span><span inner-h-t-m-l="[[_lb(comment.text)]]"></span></p>
                            <date-util format="H:mm , dd Mon yyyy" date="[[_createDate(comment.date_created)]]"></date-util>
                        </div>
                        <button id="retry" on-tap="_retryButtonTapped" hidden$="[[!comment.error]]" class="error">retry</button>
                    </div>
                </template>
        </iron-list>
        <button hidden$="[[!comments.length]]" class="loader" id="loader" on-tap="_loadMoreData">Load more...</button>

    </template>
    <script>
        Polymer({
            is: 'kw-social-comment',
            behaviors: [Kano.APIClient],
            properties: {
                comments: {
                    type: Array,
                    value: null
                },
                itemId: {
                    type: String
                },
                pageNumber: {
                    type: Number,
                    value: 0,
                    observer: "_onDataLoad"
                }
            },
            ready () {
            },
            _onDataLoad () {
                if (this.pageNumber === null) {
                    this.$.loader.style.display = "none";
                } else {
                    this.$.loader.disabled = false;
                    this.$.loader.style.background = "#ff842a";
                }
            },
            _loadMoreData (e) {
                // When we hit the last page
                if (this.pageNumber === null || !this.itemId) {
                    return;
                }
                this.$.loader.disabled = true;
                this.$.loader.style.background = "#999";
                this.fire('load-comment', { id:this.itemId, page:this.pageNumber });
            },
            _createDate (formatted) {
                return new Date(formatted);
            },
            _retryButtonTapped () {
                this.$.retry.style.display = "none";
                this.fire('post-comment', { value: this.comments[0].text, retry: true});
            },
            _commentButtonTapped () {
                this.fire('post-comment', { value: this.$.comment.value });
                this.$.comment.value = '';
            },
            _computeOptimisticClass (optimistic) {
                return optimistic ? 'optimistic' : '';
            },
            _computeErrorState (error) {
                return error ? true : '';
            },
            _isHintHidden (e) {
                return true;
            },
            _lb (value) {
                let safeDiv = document.createElement('div');
                safeDiv.textContent = value;
                return safeDiv.innerHTML.replace(/\n/g, '<br>');
            }
        });
    </script>
</dom-module>