<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/lazy-imports/lazy-imports.html">
<link rel="import" href="../kw-share-shell/kw-share-shell.html">
<link rel="import" href="../kw-share-stats/kw-share-stats.html">
<link rel="import" href="../kw-social-comment/kw-social-comment.html">
<link rel="import" href="../kano-style/color.html">
<link rel="import" href="../kano-style/typography.html">
<link rel="import" href="../kano-style/button.html">

<dom-module id="kw-share-detail">
    <link rel="lazy-import" href="../kw-art-share/kw-art-share.html" group="kw-art-share">
    <link rel="lazy-import" href="../kw-music-share/kw-music-share.html" group="kw-music-share">
    <link rel="lazy-import" href="../kw-share/kw-share.html" group="kw-share">
    <template>
        <style>
            :host {
                display: block
            }
            
            :host kw-share-shell {
                width: 100%;
            }
            
            :host .details {
                @apply --layout-vertical;
                @apply --layout-center;
                display: flex;
                width: 100%;
            }
            
            :host .details>iron-image {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            :host .bottom {
                @apply --layout-vertical;
                @apply --layout-self-stretch;
                margin: 16px;
            }

            .content {
                border-top: 1px solid var(--color-grey-mid);
                padding: 20px 2px;
            }

            kw-share-stats {
                border-top: 1px solid var(--color-grey-mid);
            }
            
            :host .bottom .content {
                @apply --layout-horizontal;
            }
            
            :host .bottom .content .description {
                color: var(--color-grey-dark);
                @apply --layout-flex;
            }
            
            :host .bottom .content .description h3 {
                margin: 0;
                font-size: 16px;
                line-height: 23px;
                color: var(--color-grey-darker);
                font-family: var(--font-body);
            }
            
            :host .bottom .content .description p {
                color: var(--color-grey-dark);
                margin-right: 16px;
                font-family: var(--font-body);
                font-weight: normal;
                font-size: 16px;
                margin-top: 8px;
                margin-bottom: 8px;
            }
            
            :host .bottom .content .actions {
                width: 25%;
                @apply --layout-horizontal;
                @apply --layout-center;
                @apply --layout-end-justified;
                padding-top: 5%;
            }
            
            .remix-button {
                @apply --kano-icon-button;
            }

            .remix-button img {
                margin-left: 3px;
                margin-top: 2px;
            }
            
            :host #share-container {
                @apply --layout-flex;
                width: 100%;
                padding: 0px 16px;
                min-height: var(--kw-share-detail-player-height, 320px);
                height: var(--kw-share-detail-player-height, 320px);
                box-sizing: border-box;
            }
            
            :host #share-container>* {
                width: 100%;
                height: 100%;
            }
            
            *[hidden] {
                display: none !important;
            }

            :host([tombstone]) .remix-button {
                color: transparent;
                opacity: 0.7;
                background: var(--color-grey-lightest);
                pointer-events: none;
            }
            
            :host([tombstone]) .detail .cover {
                background: var(--color-grey-lightest);
                color: transparent;
            }
            
            :host([tombstone]) .content .description h3 {
                width: 200px;
                height: 20px;
                background: var(--color-grey-lightest);
                color: transparent;
            }
            
            :host([tombstone]) .content .description p {
                width: 100%;
                height: 30px;
                background: var(--color-grey-lightest);
                color: transparent;
            }
            
            kw-social-comment {
                width: 100%;
            }
        </style>
        <kw-share-shell id="shell"
                        avatar-src="[[share.user.avatar.urls.circle]]"
                        username="[[share.user.username]]"
                        date="[[share.date_created]]"
                        tombstone$="[[!share]]">
            <div id="share" class="details">
                <div id="share-container"></div>
                <div class="bottom">
                    <div class="content">
                        <div class="description">
                            <h3>[[share.title]]</h3>
                            <p>[[share.description]]</p>
                        </div>
                        <div class="actions" hidden$="[[_computeAction(share.app)]]">
                            <button on-tap="_onTapRemix" class="remix-button">
                                <span>remix</span>
                                <img src="/assets/icons/shares/remix.svg" />
                            </button>
                        </div>
                    </div>
                    <kw-share-stats likes="[[share.likes.length]]" comments="[[share.comments_count]]" tombstone$="[[!share]]"></kw-share-stats>
                </div>
                <kw-social-comment comments="[[share.comments]]" tombstone$="[[!share]]"></kw-social-comment>
            </div>
        </kw-share-shell>
    </template>
    <script>
    (function() {
        const appMapping = {
            'make-music': 'kw-music-share',
            'kano-draw': 'kw-art-share',
        };

        const loadedImports = {};

        Polymer({
            is: 'kw-share-detail',
            behaviors: [Polymer.Templatizer, Polymer.LazyImportsBehavior],
            properties: {
                share: {
                    type: Object,
                    value: null
                }
            },
            observers: [
                '_shareChanged(share)'
            ],
            getShareElement() {
                return this;
            },
            _computeAction(appType) {
                return false;
                switch (appType) {
                    case 'kano-draw':
                    case 'make-apps':
                    case 'make-adventures':
                    case 'make-pong':
                        return false;
                        break;
                    case 'make-music':
                    case 'make-snake':
                    case 'make-light':
                    case 'make-minecraft':
                        return true;
                        break;
                    default:
                        return true;
                        break;
                }
            },
            _onTapRemix() {
                var url = '';
                var item = this.share;
                var appType = item.app;
                switch (appType) {
                    case 'kano-draw':
                        url = Kano.World.config.KANO_MAKEART_URL + (item.id ? '/share/' + item.id : '/');
                        break;
                    case 'make-apps':
                        var pathname = window.location.pathname.replace('/shares/', '/remix/');
                        url = Kano.World.config.KANO_CODE_URL + pathname;
                        break;
                    case 'make-adventures':
                        url = Kano.World.config.KANO_ADVENTURES_URL + (item.id ? '/shared/' + item.id : '/');
                        break;
                    case 'make-pong':
                        url = 'http://play-pong.kano.me' + (item.id ? '?project=' + item.id : '/')
                        break;
                    default:
                        break;
                }

                window.location.href = url;
            },
            _shareChanged(share) {
                let tagName, templateString, template;
                if (!this.share) {
                    return;
                }

                tagName = appMapping[this.share.app] || 'kw-share';

                if (this.instance) {
                    while (this.$['share-container'].firstChild) {
                        this.$['share-container'].removeChild(this.$['share-container'].firstChild);
                    }
                }

                if (loadedImports[tagName]) {
                    this._insertShareView(tagName);
                } else {
                    this.async(() => {
                        this.importLazyGroup(tagName).then(() => {
                            loadedImports[tagName] = true;
                            this._insertShareView(tagName);
                        });
                    });
                }
            },
            _insertShareView (tagName) {
                let templateString = `<${tagName} share="[[share]]"></${tagName}>`,
                    template = document.createElement('template');

                template.innerHTML = templateString;

                this.templatize(template);

                this.instance = this.stamp({
                    share: this.share
                });

                this.$['share-container'].appendChild(this.instance.root);
            }
        });
    })();
    </script>
</dom-module>
